---
- name: Test the execution environment (EE) repository module
  hosts: localhost
  connection: local
  become: false
  gather_facts: false
  collections:
    - galaxy.galaxy
  vars:
    hub_host: "{% if galaxy_ng_version == 'stable-4.7' %}localhost:5001{% else %}localhost:55001{% endif %}"
    ah_hostname: "{% if galaxy_ng_version == 'stable-4.7' %}http://localhost:8002/{% else %}http://localhost:8002/{% endif %}"
    ah_username: "{% if galaxy_ng_version == 'stable-4.7' %}iqe_admin{% else %}admin{% endif %}"
    ah_password: "{% if galaxy_ng_version == 'stable-4.7' %}redhat{% else %}admin{% endif %}"
    ah_path_prefix: "{% if galaxy_ng_version == 'stable-4.7' %}automation-hub{% else %}galaxy{% endif %}"
    ah_validate_certs: false
    repository: redhat_cop/config_as_code_ee
    tag: latest
    fake_image: quay.io/redhat_cop/config_as_code_ee:latest
  pre_tasks:
    - name: Include vars from ah_configs directory
      ansible.builtin.include_vars:
        dir: ./ah_configs
        extensions: ["yml"]
      tags:
        - always
  tasks:
    # Preparing an image:
    # - Pulling a small image from Quay (does not matter what image it is)
    # - Tagging it so that it can be pushed to private automation hub
    # - Pushing the image
    # - Deleting the images from the local system
    # The tasks do not use the podman collection because it may not be
    # available on the testing system.

    - name: hub_host
      ansible.builtin.debug:
        var: hub_host

    - name: ah_hostname
      ansible.builtin.debug:
        var: ah_hostname

    - name: ah_path_prefix
      ansible.builtin.debug:
        var: ah_path_prefix

    - name: Ensure a small container image is available
      ansible.builtin.command:
        cmd: "podman pull {{ fake_image }}"
      changed_when: true

    - name: Ensure the image has the correct tag
      ansible.builtin.command:
        cmd: "podman tag {{ fake_image }} {{ hub_host }}/{{ repository }}:{{ tag }}"
      changed_when: true

    - name: Ensure the image is pushed in private automation hub
      ansible.builtin.command:
        cmd: "podman push --tls-verify=false --remove-signatures
              --creds={{ ah_username }}:{{ ah_password }}
              {{ hub_host }}/{{ repository }}:{{ tag }}"
      changed_when: true

    # Preparing a README file
    - name: Ensure a temporary file exists
      ansible.builtin.tempfile:
      register: tempfile

    - name: Ensure some contents are stored in the temporary file
      ansible.builtin.copy:
        dest: "{{ tempfile['path'] }}"
        mode: 0600
        content: |
          # Mi entorno de ejecuci√≥n

          * bullet 1
          * bullet 2

    - name: Registery creation
      ansible.builtin.include_role:
        name: ee_registry

    - name: Repository creation
      ansible.builtin.include_role:
        name: ee_repository

    - name: Repository sync
      ansible.builtin.include_role:
        name: ee_repository_sync

    - name: Registery Index
      ansible.builtin.include_role:
        name: ee_registry_index
      when: galaxy_ng_version != "master"  # https://issues.redhat.com/browse/AAH-2607

    # Disabled
    #    - name: Registery sync
    #      ansible.builtin.include_role:
    #        name: ee_registry_sync

    - name: Tag image
      ansible.builtin.include_role:
        name: ee_image
      vars:
        ah_ee_images:
          # Testing adding tags to the image
          - name: "redhat_cop/config_as_code_ee:latest"
            tags:
              - v2
              - "2.0"

    - name: Append Tags to image
      ansible.builtin.include_role:
        name: ee_image
      vars:
        ah_ee_images:
          # Testing adding tags to the image
          - name: "redhat_cop/config_as_code_ee:latest"
            append: false
            tags:
              - prod2
              - prod2.0

    - name: Reset Tag
      ansible.builtin.include_role:
        name: ee_image
      vars:
        ah_ee_images:
          # Testing adding tags to the image
          - name: "redhat_cop/config_as_code_ee:prod2"
            state: present
            append: false
            tags: latest

    - name: Remove image
      ansible.builtin.include_role:
        name: ee_image
      vars:
        ah_ee_images:
          # Testing adding tags to the image
          - name: "redhat_cop/config_as_code_ee:latest"
            state: absent

    # Testing repository deletion
    - name: Ensure the repository does not exist
      ansible.builtin.include_role:
        name: ee_repository
      vars:
        ah_ee_repositories:
          - name: config_as_code_ee
            state: absent
          - name: redhat_cop/config_as_code_ee
            state: absent

    - name: Ensure the temporary file is removed
      ansible.builtin.file:
        path: "{{ tempfile['path'] }}"
        state: absent

    - name: Ensure the images are removed
      ansible.builtin.command:
        cmd: "podman rmi {{ fake_image }} {{ hub_host }}/{{ repository }}:{{ tag }}"
      changed_when: true
...
